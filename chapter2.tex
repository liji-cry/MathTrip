\chapter{容斥原理}
\section*{引言}
本章内容主要来自Brualdi <<组合数学>> 第6章(容斥原理及应用)的内容及对其的拓展与思考.

\section{容斥原理及其对偶形式}
设$S$是对象的有限集合, $P_1, P_2, \cdots, P_m$ 是 $S$ 的对象所涉及的 $m$ 个性质, 并设
\[ A_i = \{ x : x \text{ 属于 } S \text{ 且 } x \text{ 具有性质 } P_i \} \quad (i = 1, 2, \cdots, m). \]

\begin{theorem}[容斥原理的对偶形式]
    集合 $S$ 中不具有性质 $P_1, P_2, \cdots, P_m$ 的对象个数由下面的交错表达式给出：
    \begin{align*}
          & |\overline{A}_1 \cap \overline{A}_2 \cap \cdots \cap \overline{A}_m|                                                         \\
        = & |S| - \sum |A_i| + \sum |A_i \cap A_j| - \sum |A_i \cap A_j \cap A_k| + \cdots + (-1)^m |A_1 \cap A_2 \cap \cdots \cap A_m|.
    \end{align*}
\end{theorem}

\begin{proof}
    显然, 不具备$P_1, P_2, \cdots, P_m$中任何一条性质的对象对等式右边的贡献为$1$, 该贡献源于$|S|$.

    对具备$n\geq 1$条性质的对象, 我们证明它对等式右边的贡献为$0$. 它对集合$|S|$, $\sum |A_i|$, $\sum |A_i \cap A_j|$, $\cdots$的贡献依次为: $1$, $\binom{n}{1}$, $\binom{n}{2}$, $\cdots$. 由推论\ref{exstl1}得其在等式右边贡献和为
    $$\binom{n}{0} - \binom{n}{1} + \binom{n}{2} - \binom{n}{3} + \cdots + (-1)^n \binom{n}{n}=0.$$
    即证.
\end{proof}

\begin{theorem}[容斥原理]
    集合 $S$ 中至少具有性质 $P_1, P_2, \cdots, P_m$ 之一的对象个数由下式给出：
    \begin{align*}
         & |A_1 \cup A_2 \cup \cdots \cup A_m| \\=&\sum |A_i| - \sum |A_i \cap A_j| + \sum |A_i \cap A_j \cap A_k| - \cdots + (-1)^{m+1} |A_1 \cap A_2 \cap \cdots \cap A_m|.
    \end{align*}
\end{theorem}
\begin{proof}
    由德摩根律
    $$\overline{A_1 \cup A_2 \cup \cdots \cup A_m} = \overline{A}_1 \cap \overline{A}_2 \cap \cdots \cap \overline{A}_m.$$

    因此,
    \begin{align*}
          & |A_1 \cup A_2 \cup \cdots \cup A_m|                                                                                        \\=&|S|-\overline{A_1 \cup A_2 \cup \cdots \cup A_m}\\
        = & |S|-\overline{A}_1 \cap \overline{A}_2 \cap \cdots \cap \overline{A}_m                                                     \\
        = & \sum |A_i| - \sum |A_i \cap A_j| + \sum |A_i \cap A_j \cap A_k| - \cdots + (-1)^{m+1} |A_1 \cap A_2 \cap \cdots \cap A_m|.
    \end{align*}
\end{proof}

\section{Möbius反演}
考虑一个有限偏序集$(X,\leq)$. 设 $\mathcal{F}(X)$ 是满足只要 $x \leq y$ 就有 $f(x, y) = 0$ 的所有实值函数
\[ f : X \times X \rightarrow \mathbb{R} \]
的集合, 于是 $f(x, y)$ 只在 $x \leq y$ 时可能不等于 0. 我们如下定义 $\mathcal{F}(X)$ 中两个函数 $f$ 和 $g$ 的卷积 $h = f * g$:

\[ h(x, y) = \begin{cases}
        \sum_{z : x \leq z \leq y} f(x, z) g(z, y) & \text{若 } x \leq y, \\
        0                                          & \text{其他.}
    \end{cases} \]
\begin{lemma}\label{juanjijiehel}
    卷积满足结合律. 即$f * (g * h) = (f * g) * h \quad (f, g, h \in \mathcal{F}(X))$.
\end{lemma}
\begin{proof}证明$x\leq y$的情况.
    \begin{align*}
        f*(g*h)(x,y)= & \sum_{z:x\leq z\leq y}f(x,z)\cdot (g*h)(z,y)                        \\
        =             & \sum_{z:x\leq z\leq y}f(x,z)\sum_{z':z\leq z'\leq y}g(z,z')h(z',y)  \\
        =             & \sum_{z:x\leq z\leq y}\sum_{z':z\leq z'\leq y}f(x,z)g(z,z')h(z',y)  \\
        =             & \sum_{z':x\leq z'\leq y}\sum_{z:x\leq z\leq z'}f(x,z)g(z,z')h(z',y) \\
        =             & \sum_{z':x\leq z'\leq y}(f*g)(x,z')\cdot h(z',y)                    \\
        =             & (f * g) * h(x,y).
    \end{align*}
    即证.
\end{proof}

我们考虑$\mathcal{F}(X)$中三种特殊的函数:
\begin{itemize}
    \item $\delta$函数: $$\delta(x, y) =
              \begin{cases}
                  1 & \text{若 } x = y \\
                  0 & \text{其他}
              \end{cases}$$
          对所有的$f\in \mathcal{F}(X)$, 有$\delta*f=f*\delta=f$, 故称$\delta$为卷积下的恒等函数.
    \item $\zeta$函数: $$\zeta(x, y) =
              \begin{cases}
                  1 & \text{若 } x \leq y \\
                  0 & \text{其他}
              \end{cases}$$
          $\zeta$函数是偏序集$(X,\leq)$的一种表示.
    \item Möbius函数$\mu$: $\zeta$函数在卷积下的逆函数.
\end{itemize}

\begin{lemma}\label{逆函数引理}
    设 $f$ 是 $\mathcal{F}(X)$ 中的函数, 对 $X$ 中的所有 $y$ 满足 $f(y, y) \neq 0$. 则$f$在卷积下存在逆函数.
\end{lemma}

\begin{proof}
    如下递归地定义$\mathcal{F}(X)$ 中的函数$g$:

    首先, 由于$f(y, y) \neq 0$, 可以定义 $$g(y, y) = \frac{1}{f(y, y)} \quad (y \in X).$$

    然后, $$g(x, y) = -\frac{1}{f(y, y)} \sum_{z:x\leq z < y} g(x, z) f(z, y) \quad (x < y).$$

    于是, 不难观察到 $$\sum_{z:x\leq z \leq y} g(x, z) f(z, y) = \delta(x, y) \quad (x \leq y)$$

    即证$g$是$f$在卷积意义下的左逆函数: $g*f=\delta$.

    同理可以证明$f$存在卷积意义下的右逆函数: $f*h=\delta$. 由引理\ref{juanjijiehel}, $$g = g * \delta = g * (f * h) = (g * f) * h = \delta * h = h.$$

    即证, $g$是$f$的逆函数.
\end{proof}

因此, 由于$\mu*\zeta=\delta$, 我们得到
$$\sum_{z : x \leq z \leq y} \mu(x, z) \zeta(z, y) = \sum_{z : x \leq z \leq y} \mu(x, z)=\delta(x, y) \quad (x \leq y).$$

由上式可知对所有的$x\in X$, 有$\mu(x,x)=1$. 以及$$\mu(x, y) = -\sum_{z : x \leq z < y} \mu(x, z) \quad (x < y)$$

利用$\mu$是$\zeta$的右逆函数也可以得到对偶的类似结果.

\begin{theorem}[Möbius反演]\label{mu反演}
    设 $(X, \leq)$ 是偏序集且有最小元 $0$. 设 $\mu$ 是它的Möbius函数, 并设 $F$ : $X \rightarrow \mathbb{R}$ 是定义在 $X$ 上的实值函数. 设函数 $G$ : $X \rightarrow \mathbb{R}$ 是如下定义的函数:
    \[ G(x) = \sum_{z : z \leq x} F(z) \quad (x \in X) \]

    那么
    \[ F(x) = \sum_{y : y \leq x} G(y) \mu(y, x) \quad (x \in X). \]
\end{theorem}

\begin{proof}
    \begin{align*}
        \sum_{y : y \leq x} G(y) \mu(y, x) & = \sum_{y : y \leq x} \sum_{z : z \leq y} F(z) \mu(y, x)                                  \\
                                           & = \sum_{y : y \leq x} \mu(y, x) \sum_{z : z \in X} \zeta(z, y) F(z)                       \\
                                           & = \sum_{z : z \in X} \sum_{y : y \leq x} \zeta(z, y) \mu(y, x) F(z)                       \\
                                           & = \sum_{z : z \in X} \left( \sum_{y : z \leq y \leq x} \zeta(z, y) \mu(y, x) \right) F(z) \\
                                           & = \sum_{z : z \in X} \delta(z, x) F(z)                                                    \\
                                           & = F(x).
    \end{align*}
    即证. (第二个等式构造出\(\zeta\) 函数)
\end{proof}

\section{\(\mu\)函数及其性质}
\begin{corollary}\label{umumu1}
    偏序集\((\mathcal{P}(X_n),\subseteq) \)的\(\mu\)函数. 设\(|X_n|=n\), $A,B$是\(X_n\)的子集且\(A\subseteq B\). 那么\[\mu(A,B)=(-1)^{|B|-|A|}.\]
\end{corollary}
\begin{proof}
    由于\(\mu\)是\(\zeta\)的逆函数, \(\mu(A,A)=1\). 因此当\(B=A\)时, 等式成立.

    当\(A\subsetneq B\)时, 应用归纳法. 令\(p=|B\backslash A|=|B|-|A|.\)根据引理\ref{逆函数引理}的推论和归纳假设(对于\(C: A \subseteq C \subseteq B\)时假设成立), 我们得到
    \[\mu(A,B) = -\sum_{C: A \subseteq C \subseteq B} \mu(A,C) = - \sum_{C: A \subseteq C \subseteq B} (-1)^{|C|-|A|} = - \sum_{k=0}^{p-1} (-1)^k \binom{p}{k}.\]

    根据二项式定理, 我们有
    \[0 = (1 - 1)^p = \sum_{k=0}^{p} (-1)^k \binom{p}{k}.\]

    于是
    \[\sum_{k=0}^{p-1} (-1)^k \binom{p}{k} = -(-1)^p \binom{p}{p}.\]

    回代\(\mu\)的式子中
    \[\mu(A,B) = (-1)^p \binom{p}{p} = (-1)^p = (-1)^{|B|-|A|}.\]

    即证.
\end{proof}

\begin{corollary}
    线性有序集的\(\mu\)函数. 考虑线性有序集 $(X_n, \leqslant)$, 其中 $1 < 2 < \cdots < n$. 我们有\[\mu(k,l) =
        \begin{cases}
            1  & \text{若 } l = k     \\
            -1 & \text{若 } l = k + 1 \\
            0  & \text{其他.}
        \end{cases}\]
\end{corollary}
\begin{proof}
    由归纳法易证.
\end{proof}

结合定理\ref{mu反演}和推论\ref{umumu1}, 还能得到以下推论.

\begin{corollary}\label{233}
    设 \( X_n = \{1, 2, \cdots, n\} \), 且设 \( F: \mathcal{P}(X_n) \to \mathbb{R} \) 为定义在 \( X_n \) 的子集上的函数. 设 \( G: \mathcal{P}(X_n) \to \mathbb{R} \) 是由下式定义的函数：
    \[ G(K) = \sum_{L \subseteq K} F(L) \quad (K \subseteq X_n) \]
    那么
    \[ F(K) = \sum_{L \subseteq K} (-1)^{|K| - |L|} G(L) \quad (K \subseteq X_n). \]
\end{corollary}

接下来我们考虑直积与其各分量偏序集的\(\mu\)函数的关系. 设 \((X, \leqslant_1)\) 和 \((Y, \leqslant_2)\) 为两个偏序集. 在下面的集合
\[ X \times Y = \{(x, y) : x \in X, y \in Y\} \]
上定义关系 \(\leqslant\) 为
\[ (x, y) \leqslant (x', y') \text{ 当且仅当 } x \leqslant_1 x' \text{ 且 } y \leqslant_2 y'. \]
容易直接验证 \((X \times Y, \leqslant)\) 是一个偏序集, 叫做 \((X, \leqslant_1)\) 和 \((Y, \leqslant_2)\) 的直积. 我们可以把这个直积结构扩展到任意个偏序集上.

\begin{theorem}[直积的Möbius函数]\label{直积的Möbius函数}
    设 $(X, \leqslant_1)$ 和 $(Y, \leqslant_2)$ 为两个有限偏序集, 且它们的Möbius函数分别为 $\mu_1$ 和 $\mu_2$. 设 $\mu$ 为 $(X, \leqslant_1)$ 和 $(Y, \leqslant_2)$ 的直积的Möbius函数. 则
    \[
        \mu((x,y),(x',y')) = \mu_1(x,x')\mu_2(y,y'). \quad ((x,y),(x',y') \in X \times Y)
    \]
\end{theorem}

\begin{proof}
    当\((x,y)\nleq (x',y')\)或\((x,y)= (x',y')\)时, 容易验证上式成立. 接下来我们对于\((x,y)\leq (x',y')\)且\((x,y)\neq (x',y')\)的情况使用归纳法:

    \begin{align*}
        \mu((x,y),(x',y')) & = -\sum_{(u,v) : (x,y) \leqslant (u,v) < (x',y')} \mu((u,v),(x',y'))                            \\
                           & = -\sum_{(u,v) : (x,y) \leqslant (u,v) < (x',y')} \mu_1(u,x')\mu_2(v,y'). \quad \text{（根据归纳假设）}
    \end{align*}

    由于求和变量在两项乘数之间的独立性, 可以将上式分解为两个和式的积:

    \begin{align*}
        \text{原式} & = - \Big( \sum_{u: x\leqslant_1 u \leqslant_1 x'} \mu_1(u, x') \Big) \Big( \sum_{v: y\leqslant_2 v \leqslant_2 y'} \mu_2(v, y') \Big) \quad + \mu_1(x, x') \mu_2(y, y') \\
                  & =-\delta(x,x')\delta(y,y')+ \mu_1(x, x') \mu_2(y, y').
    \end{align*}

    由于\((x,y)\neq (x',y')\), \(\delta(x,x')\)和\(\delta(y,y')\)中至少一项为0. 即证.
\end{proof}

\begin{theorem}\label{经典mu}
    设 \( F \) 为定义在正整数集上的实值函数. 如下定义这个正整数集上的实值函数 \( G \):

    \[ G(n) = \sum_{k:k \mid n} F(k). \]

    这时, 对于每一个正整数 \( n \), 我们有

    \[ F(n) = \sum_{k:k \mid n} \mu\left(n/k\right) G(k) \]

    其中把 \( \mu(1, n/k) \) 写作 \( \mu(n/k) \).
\end{theorem}

\begin{proof}
    设\(n\)是正整数, \(X_n=\{1,2,\cdots,n\}\). 我们考虑整除关系下的偏序集\(D_n=(X_n, \mid )\). 我们首先说明, 如果 \( a \mid b \)，则 \( \mu(a, b) = \mu\left(1, b/a\right) \). 设\([a,b]\)是所有既能整除\(a\)又能整除\(b\)的集合, 也就是说, \(\forall s\in [a,b]\), 有\(s\mid a, s\mid b\). 我们考虑作用在集合\([a,b]\)上的映射\(f[a,b]=[1,b/a]\), 对于任意\(s\in [a,b]\), 存在唯一的\(t=s/a\in [1,b/a]\)与之对应, 因此\(f\)是双射, 且保持了偏序关系的一致性. 因此, 在偏序关系下\([a,b]\)和\([1,b/a]\)是同构的(表现的是同一个偏序集), 所以\( \mu(a, b) = \mu\left(1, b/a\right) \).

    整数 $n$ 有唯一素数因数分解
    \(n = p_1^{\alpha_1} p_2^{\alpha_2} \cdots p_k^{\alpha_k} \),
    其中 $p_1, p_2, \cdots, p_k$ 是互不相同的素数, 而 $\alpha_1, \alpha_2, \cdots, \alpha_k$ 为正整数. 根据引理\ref{逆函数引理}, 可以得到

    \[\mu(1, n) = -\sum_{m \geq 1, m \mid n, m \neq n} \mu(1, m).\]

    由于\(m\mid n\), \(m\)必须满足\(m=p_1^{\beta_1} p_2^{\beta_2} \cdots p_k^{\beta_k}\)且\(\beta_i\leq\alpha_i\). 因此, 我们其实只需考虑\(X_n\)中满足\(k\mid n\)的所有正整数\(k\)组成的子集\(X^*_n\), 偏序集\((X^*_n, \mid \))其实是\(k\)个线性序($1\mid p_i\mid p_i^2\mid\cdots\mid p_{i}^{\alpha_i}$)的直积. 根据定理\ref{直积的Möbius函数}

    \[\mu(1, n) = \prod_{i=1}^{k} \mu(1, p_i^{\alpha_i}).\]

    结合推论\ref{umumu1}, 我们得到\[\mu(1, n) =
        \begin{cases}
            1      & \text{若 } n = 1                        \\
            (-1)^k & \text{若 } n \text{是}k\text{个互不相同素数的乘积} \\
            0      & \text{其他情形.}
        \end{cases}\]

    应用定理\ref{mu反演}, 我们即得到最终结果.
\end{proof}

\section{Möbius反演的应用}
\begin{example}
    把\(n\)个非攻击型车放到带禁止位置的\(n\times n\)棋盘的放置方法数.
\end{example}

我们将棋盘建模为\(n\times n\)的矩阵\(A\), 其中禁止位置的点值为0, 其余点值为1. 一般地, $n \times n$ 棋盘上 $n$ 个非攻击型车对应于矩阵中的 $n$ 个 1, 且每行和每列上恰好有一个 1. 
这些 1 又对应于 $\mathcal{P}_n$ 中的双射
\[ f: \{1,2,\cdots,n\} \to \{1,2,\cdots,n\} \]
其中 $a_{ij(i)} = 1, \ i = 1, 2, \cdots, n$, 或等价地
\[ \prod_{i=1}^{n} a_{if(i)} = a_{1f(1)} a_{2f(2)} \cdots a_{nf(n)} = 1 \]
如果 $f$ 是对于某个 $i$ 有 $a_{if(i)} = 0$ 的双射, 那么
\[ \prod_{i=1}^{n} a_{if(i)} = a_{1f(1)} a_{2f(2)} \cdots a_{nf(n)} = 0 .\]

因此, 我们可以得到放置方法数为\[\sum_{f \in \mathcal{P}_n} \prod_{i=1}^{n} a_{if(i)}.\]
这个表达式被称为\(A\)的不变式, 是一个重要的组合函数.

考虑偏序集 $(\mathcal{P}(X_n), \subseteq)$. $X_n$ 的每一个基数为 $k$ 的子集 $S$ 从 $A$ 挑选 $k$ 个列的集合, 我们把由这些列组成的 $n \times k$ 子矩阵记作 $A[S]$. 设 $\mathcal{F}_n(S)$ 表示所有函数 $f: \{1, 2, \ldots, n\} \to S$ 的集合, 并设 $\mathcal{G}_n(S)$ 表示满射函数的子集. 于是, 我们有
\[
\mathcal{F}_n(S) = \bigcup_{T \subseteq S} \mathcal{G}_n(T)
\]

如下定义函数 $F: \mathcal{P}(X_n) \to \mathbb{R}$:
\[
F(S) = \sum_{f \in \mathcal{G}_n(S)} \prod_{i=1}^n a_{if(i)}, \quad (S \subseteq X_n)
\]

(此处, 如果 $S = \varnothing$, 则 $F(S) = 0$). 注意, $F(X_n)=\sum_{f \in \mathcal{P}_n} \prod_{i=1}^{n} a_{if(i)}$. 我们的目标就是进一步计数$F(X_n)$.

设\[G(S)=\sum_{T\subseteq S}F(T)=\sum_{T\subseteq S}\sum_{f \in \mathcal{G}_n(T)} \prod_{i=1}^n a_{if(i)}, \quad (S \subseteq X_n).\]

由于$\mathcal{G}_n(S)$ 是满射函数的子集, 对于不同的\(T_1\neq T_2\), $\mathcal{G}_n(T_1)$和$\mathcal{G}_n(T_2)$ 无交集. 加上\(\mathcal{F}_n(S) = \bigcup_{T \subseteq S} \mathcal{G}_n(T)\), 我们将求和项从有限制集合\(\mathcal{G}\)改写到了无限制集合\(\mathcal{F}\)上:

\[G(S) = \sum_{g\in \mathcal{F}_n(S)} \prod_{i=1}^{n} a_{ig(i)}=\prod_{i=1}^{n} (\sum_{j\in S}a_{ij}). \quad (S \subseteq X_n)\]

由推论\ref{233}, \[F(X_n) = \sum_{S \subseteq X_n} (-1)^{n - |S|} G(S)= \sum_{S \subseteq X_n} (-1)^{n - |S|}\prod_{i=1}^{n} (\sum_{j\in S}a_{ij}).\]

\begin{example}
    欧拉\(\varphi\)函数的计算. 该函数对于正整数 $n$ 的定义是
\[ \varphi(n) = |S_n| \]

其中
\[ S_n = \{ k : 1 \leq k \leq n, \gcd(k, n) = 1 \} .\]
\end{example}

我们进一步推广\(S_n\), 设\[S_n^d = \{ k : 1 \leq k \leq n, \gcd(k, n) = d \} \quad (d \text{ 是 } n \text{ 的正因子})\]
显然有\(S_n=S_{n}^1\). 对于任意满足\(\gcd(k,n)=d\)的整数\(k\), 它必然唯一对应\(k=dk'\)且\(\gcd(k',n/d)=1\). 因此\(|S_{n}^d|=\varphi(n/d)\). 设
\[G(n)=\sum_{d:d|n}\varphi(d)\]
由于每一个\(1\leq k\leq n\), \(\gcd(k,n)\)是唯一的, 因此\(G(n)=n\), 即\(n=\sum_{d:d|n}\varphi(d)\).

根据定理\ref{经典mu}, 得

\[\varphi(n) = \sum_{d:d\mid n} \mu\left(\frac{n}{d}\right)d = \sum_{d:d\mid n} \mu(d)\frac{n}{d}.\]

此时, $\mu(d)$ 非 0 当且仅当 $d=1$ 或 $d$ 是互不相同的素数的乘积; 对于后面的情况, $\mu(d)=(-1)^r$, 其中 $r$ 是 $d$ 中互不相同素数的个数. 设这些整除\(n\)的所有互异素数为 $p_1, p_2, \ldots, p_r$. 这时, 
\[\varphi(n)=
n - \left( \frac{n}{p_1} + \frac{n}{p_2} + \cdots \right)
+ \left( \frac{n}{p_1p_2} + \frac{n}{p_1p_3} + \cdots \right)
+ \cdots + (-1)^r \frac{n}{p_1p_2 \cdots p_r},
\]
而这正是下面的乘积展开式:
\[
n \prod_{i=1}^{r} \left(1 - \frac{1}{p_i}\right)
\]
因此, 有
\[
\varphi(n) = n \prod_{p \mid n} \left(1 - \frac{1}{p}\right)
\]
其中, 乘积是对所有整除 $n$ 的互不相同素数 $p$ 求积.

\begin{example}
    计算 $k$ 个不同符号 $a_1, a_2, \cdots, a_k$ 的循环 $n$ 排列的个数, 其中, 每一个符号都可以使用任意多次, 或等价地, 我们计算多重集合 $\{n \cdot a_1, n \cdot a_2, \cdots, n \cdot a_k\}$ 的循环 $n$ 排列的数目.
\end{example}

处理这个问题依旧遵循从计数有限制集合反演到计数无限制集合的思路. 我们说一个本原线性串的长度为\(m\), 指这个线性串长度为\(m\)且不能被其自身的子串循环表示. 首先我们定义有限制集合, 设\(f(m)\)为使用符号$a_1, a_2, \cdots, a_k$的长度为\(m\)的本原线性串的个数. 再设\(h(n)\)为我们最终要求的使用$k$ 个不同符号 $a_1, a_2, \cdots, a_k$ 的循环 $n$ 排列的个数.

因为\(n\)的所有因子对应的不同长度\(d\)的本原线性串, 每个本原线性串通过倍增操作得到长度为\(n\)的线性串是唯一的, 且对于本原长度\(d\), 会有\(d\)个不同的本原线性串对应同一个循环排列. 于是

\[h(n) = \sum_{d : d \mid n} \frac{f(d)}{d}.\]

接下来, 我们期望将计数有限制集合的函数\(f(m)\)转化到计数无限制集合的函数\(g(m)\)上. 我们定义\(g(m)\)为长度为\(m\)的线性串的总数, 它或者由长度为\(m\)的本原线性串得到, 或者由长度为\(x,\text{满足}x|m\)的本原线性串倍增得到. 因此

\[g(m) = \sum_{e : e \mid m} f(e)=k^m.\]

根据定理\ref{经典mu}, \[f(m) = \sum_{e: e| m} \mu(m/e) g(e) = \sum_{e: e| m} \mu(m/e) k^e.\]

带入\(h(n)\)的式子, 

\[h(n)=\sum_{d : d \mid n} \frac{f(d)}{d}=\sum_{d : d \mid n}\sum_{e:e|d}\frac{1}{d} \mu(d/e)k^e.\]

我们考虑代换\(d=me\)并交换求和次序

\[h(n)=\sum_{e: e| m} \left( \sum_{m: m| n/e} \frac{1}{me} \mu(m) \right) k^e.\]

接下来一步较难想到. 我们想使用欧拉数的反演结论, 也就是\[\varphi(n) = \sum_{d:d\mid n} \mu\left(\frac{n}{d}\right)d = \sum_{d:d\mid n} \mu(d)\frac{n}{d}.\]
注意到反演公式的和式内为\(2\)项相乘的形式, \(\mu\)项和常数项内部差一个因子\(d\). 我们想把\(h(n)\)的表达式转化到这种形式.

设\(n/e=rm\), \[h(n)=\sum_{e: e| n} \left( \sum_{r: r| n/e} \frac{r}{n} \mu\left(\frac{n/e}{r}\right) \right) k^e=\sum_{\{e: e| n\}} \frac{\varphi(n/e)}{n} k^e=\frac{1}{n}\sum_{\{e: e| n\}}\varphi(n/e)k^e.\]
